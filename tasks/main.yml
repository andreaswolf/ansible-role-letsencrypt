---

#################################################
# one time setup
#################################################

- name: create data directory
  file:
    path: '{{ acme_tiny_data_directory }}'
    state: directory

- name: create csr directory
  file:
    path: '{{ acme_tiny_data_directory }}/csrs'
    state: directory

- name: create user
  user:
    name: '{{ letsencrypt_user }}'
    home: '{{ acme_tiny_data_directory }}'
    system: yes

- name: create group
  group:
    name: '{{ letsencrypt_group }}'
    system: yes

- name: create program directory
  file:
    path: '{{ acme_tiny_software_directory }}'
    state: directory

- name: create challenges directory
  file:
    path: '{{ acme_tiny_challenges_directory }}'
    state: directory
    owner: '{{ letsencrypt_user }}'
    group: '{{ letsencrypt_group }}'

- name: ensure correct permissions on data directory
  file:
    path: '{{ acme_tiny_data_directory }}'
    state: directory
    mode: 0700
    owner: '{{ letsencrypt_user }}'
    group: '{{ letsencrypt_group }}'
    recurse: true

- name: clone acme-tiny repository
  git:
    dest: '{{ acme_tiny_software_directory }}'
    repo: '{{ acme_tiny_repo }}'
    version: '{{ acme_tiny_commit }}'
    accept_hostkey: yes

- name: generate account key
  shell: "openssl genrsa 4096 > {{ letsencrypt_account_key }}"
  args:
    creates: "{{ letsencrypt_account_key }}"


#################################################
# key setup

- name: generate private keys
  shell: "openssl genrsa 4096 > {{ item.keypath }}"
  args:
    creates: "{{ item.keypath }}"
  with_items: letsencrypt_certs

- name: generate csrs
  shell: "openssl req -new -sha256 -key '{{ item.keypath }}' -subj '/CN={{ item.host }}'
    > {{ acme_tiny_data_directory }}/csrs/{{ item.name }}.csr"
  args:
    creates: "{{ acme_tiny_data_directory }}/csrs/{{ item.name }}.csr"
  with_items: letsencrypt_certs

- name: generate script
  template:
    src: renew-certs.py
    dest: "{{ acme_tiny_data_directory }}/renew-certs.py"
    mode: 0700
    owner: '{{ letsencrypt_user }}'
    group: '{{ letsencrypt_group }}'

#################################################
# cron setup

- name: install cronjob for key generation
  cron:
    job: "cd {{ acme_tiny_data_directory }} && ./renew-certs.py"
    # run the job every month so we get a new certificate in time, even if it fails on the first attempt
    day: 1
    hour: 4
    minute: 30
    state: present
    name: "letsencrypt certificate renewal"
    user: "{{ letsencrypt_user }}"

...t

- name: generate private keys
  shell: "openssl genrsa 4096 > {{ item.keypath }}"
  args:
    creates: "{{ item.keypath }}"
  with_items: letsencrypt_certs
  tags: letsencrypt

- name: generate csrs for singledomain keys
  shell: "openssl req -new -sha256 -key '{{ item.keypath }}' -subj '/CN={{ item.host }}'
    > {{ acme_tiny_data_directory }}/csrs/{{ item.name }}.csr"
  args:
    creates: "{{ acme_tiny_data_directory }}/csrs/{{ item.name }}.csr"
  when: not {{ item.multiple|default(false) }}
  with_items: letsencrypt_certs
  tags: letsencrypt
  # notify: generate certs

- name: generate csrs for multidomain keys
  raw: "openssl req -new -sha256 -key '{{ item.keypath }}' -subj '/' -reqexts SAN -config <(cat /etc/ssl/openssl.cnf <(printf '[SAN]\nsubjectAltName=DNS:{{ item.hosts|join(',DNS:') }}')) > {{ acme_tiny_data_directory }}/csrs/{{ item.name }}.csr"
  args:
    creates: "{{ acme_tiny_data_directory }}/csrs/{{ item.name }}.csr"
  when: item.multiple|default(false)
  with_items: letsencrypt_certs
  tags: letsencrypt
  # notify: generate certs

#################################################
# cron setup

- name: install cronjob for key generation
  cron:
    job: "cd {{ acme_tiny_data_directory }} && ./renew-certs.py"
    # run the job every week so we get a new certificate in time, even if it fails on the first attempt
    special_time: weekly
    cron_file: letsencrypt
    state: present
    name: "letsencrypt certificate renewal"
    user: "{{ letsencrypt_user }}"
  tags: letsencrypt

...
